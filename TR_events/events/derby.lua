local data = {
    ["monsterDerby"] = {
        fallCol = createColCuboid(4108.2841796875, -1683.5920410156, 208.523712158, 210, 160, 15),
        centerPos = Vector2(4215.4467773438, -1601.4320068359),
        distance = 34,
        model = 444,
    },

    ["standardDerby"] = {
        fallCol = createColCuboid(2974.06640625, 310.4755859375, -15, 210, 160, 15),
        model = 415,
        pos = {
            Vector4(2997.8583984375, 349.89453125, 16.992170333, 270),
            Vector4(3173.6328125, 349.8544921875, 16.98956871032, 90),
            Vector4(2999.0673828125, 385.130859375, 16.7194232, 270),
            Vector4(2997.6220703125, 407.849609375, 16.729364395, 270),
            Vector4(2997.5390625, 425.4296875, 16.729337692, 270),
            Vector4(3038.423828125, 402.865234375, 16.68903, 360),
            Vector4(3038.5205078125, 371.0625, 16.728868, 180),
            Vector4(3172.9892578125, 367.7177734375, 16.7216, 90),
            Vector4(3173.0146484375, 385.3740234375, 16.718664169, 90),
            Vector4(3173.3818359375, 407.927734375, 16.7162342071, 90),
            Vector4(3173.458984375, 425.314453125, 16.72028732299, 90),
            Vector4(3132.7080078125, 372.9375, 16.737043380, 180),
            Vector4(3132.3515625, 401.4541015625, 16.6971378, 360),
            Vector4(3160.0703125, 332.98046875, 3.2713637351, 0),
            Vector4(3159.703125, 448.62890625, 3.25980997085, 180),
            Vector4(3137.892578125, 448.04296875, 3.26345562934, 180),
            Vector4(3126.8623046875, 448.501953125, 3.2586, 90),
            Vector4(3073.9921875, 448.5205078125, 3.27668833, 180),
            Vector4(3033.7177734375, 448.7705078125, 3.264978647, 180),
            Vector4(3032.998046875, 331.736328125, 3.271132707, 360),
            Vector4(3084.87109375, 332.16015625, 3.27290177, 270),
            Vector4(3137.720703125, 332.8857421875, 3.2684707, 0),
            Vector4(3084.98828125, 372.650390625, 9.047644, 270),
            Vector4(3086.8349609375, 413.0947265625, 9.0561561584, 270),
            Vector4(3087.1044921875, 418.7939453125, 3.2661287, 270),
            Vector4(3111.9501953125, 395.2763671875, 7.34844398, 180),
            Vector4(3126.1318359375, 389.9580078125, 4.862715244293, 180),
            Vector4(3058.6962890625, 396.791015625, 7.253444671, 360),
            Vector4(3044.556640625, 396.869140625, 4.77445316, 360),
            Vector4(3059.744140625, 367.5703125, 3.260279655, 90),
            
        },
    },

    ['randomDerby'] = {
        vehicles = {
         602, 429, 402, 541, 415, 480, 562, 587, 565, 559, 603, 506, 558, 555, 536, 575,
         518, 419, 534, 576, 412, 496, 401, 527, 542, 533, 526, 474, 545, 517, 410, 436,
         475, 439, 549, 491, 599, 552, 499, 422, 414, 600, 543, 478, 456, 554, 589, 500,
         489, 442, 495, 560, 567, 445, 438, 507, 585, 466, 492, 546, 551, 516, 467, 426,
         547, 405, 580, 550, 566, 420, 540, 421, 529, 490, 596, 598, 597, 418, 579, 400,
         470, 404, 479, 458, 561, 411, 451, 477, 535, 528, 525, 508, 494, 502, 503, 423,
         416, 427, 609, 498, 428, 459, 482, 582, 413, 440, 433, 524, 455, 403, 443, 515,
         514, 408, 407, 544, 601, 573, 574, 483, 588, 434, 444, 583, 409
        },

        fallCol = createColCuboid(6020.3828125, -706.70111083984, 20.493709564209, 280, 350, 15),
        pos = {
            Vector3(6065.3466796875, -665.01727294922, 270),
            Vector3(6060.8579101563, -659.32830810547, 0),
            Vector3(6059.9775390625, -417.20843505859, 180),
            Vector3(6065.2724609375, -412.57693481445, 270),
            Vector3(6251.9375, -411.62759399414, 90),
            Vector3(6256.7319335938, -417.33190917969, 180),
            Vector3(6257.7919921875, -659.51733398438, 0),
            Vector3(6252.0263671875, -664.15484619141, 90),
            Vector3(6194.3959960938, -670.53625488281, 0),
            Vector3(6123.80078125, -670.11401367188, 0),
            Vector3(6123.0390625, -406.33178710938, 180),
            Vector3(6193.4145507813, -406.23809814453, 180),
            Vector3(6252.4692382813, -537.95318603516, 90),
            Vector3(6065.4624023438, -538.77435302734, 270),
            Vector3(6065.724609375, -602.06188964844, 270),
            Vector3(6252.1689453125, -601.02056884766, 90),
            Vector3(6251.50390625, -474.82205200195, 90),
            Vector3(6065.7612304688, -475.78598022461, 270),

            Vector3(6060.8491210938, -533.11614990234, 0),
            Vector3(6059.8291015625, -543.93524169922, 180),
            Vector3(6257.6342773438, -532.48663330078, 0),
            Vector3(6256.8227539063, -543.71270751953, 180),

            Vector3(6151.7329101563, -543.68591308594, 130),
            Vector3(6158.5522460938, -547.38067626953, 174),
            Vector3(6164.2778320313, -545.72302246094, 220),
            Vector3(6167.939453125, -538.84222412109, 270),
            Vector3(6165.7705078125, -532.83081054688, 310),
            Vector3(6159.2978515625, -529.83935546875, 0),
            Vector3(6153.2275390625, -531.70135498047, 40),
            Vector3(6148.8969726563, -537.86199951172, 90),
        },
    },
}

local rmarker = createMarker(6158.921875, -601.463867187, 46.7284698486, 'ring', 2.5, 0, 0, 255, 255)
local rmarker2 = createMarker(6158.333984375, -475.33184814453, 46.72846984863, 'ring', 2.5, 0, 0, 255, 255)

addEventHandler("onMarkerHit", rmarker, function(element, mdim)
    if isElement(element) and getElementType(element) == "player" and isPedInVehicle(element) then
        local playerX, playerY, playerZ = getElementPosition(element)
        math.randomseed(os.time())
        local randomVehicleId = data.randomDerby.vehicles[math.random(1,#data.randomDerby.vehicles)]
        local vehicle = getPedOccupiedVehicle(element)
        setElementModel(vehicle, randomVehicleId)

        math.randomseed(os.time())
        local rnd2 = math.random(0, 255)

        setMarkerColor(rmarker, math.random(0, 255), math.random(0, 255), math.random(0, 255), 255)
    end
end)

addEventHandler("onMarkerHit", rmarker2, function(element, mdim)
    if isElement(element) and getElementType(element) == "player" and isPedInVehicle(element) then
        local playerX, playerY, playerZ = getElementPosition(element)
        math.randomseed(os.time())
        local randomVehicleId = data.randomDerby.vehicles[math.random(1,#data.randomDerby.vehicles)]
        local vehicle = getPedOccupiedVehicle(element)
        setElementModel(vehicle, randomVehicleId)

        setMarkerColor(rmarker2, math.random(0, 255), math.random(0, 255), math.random(0, 255), 255)
        setVehicleColor(vehicle, math.random(0, 255), math.random(0, 255), math.random(0, 255), math.random(0, 255), math.random(0, 255), math.random(0, 255))
    end
end)

function createMonsterDerbyVehicles()
    local angleSwitch = 360 / eventData.playerCount
    local index = 0

    for i, v in pairs(eventData.playersLeft) do
        local x, y = getPointFromDistanceRotation(data.monsterDerby.centerPos.x, data.monsterDerby.centerPos.y, data.monsterDerby.distance, angleSwitch * index)
        local rot = findRotation(x, y, data.monsterDerby.centerPos.x, data.monsterDerby.centerPos.y)

        setElementInterior(i, 0)
        setElementDimension(i, 0)

        local veh = createVehicle(data.monsterDerby.model, x, y, 237, 0, 0, rot)
        setElementData(veh, "vehicleData", {
            fuel = 80,
            mileage = math.random(20000, 50000)
        }, false)
        setElementData(i, "engineState", true, false)
        setElementData(veh, "blockAction", true)
        setVehicleEngineState(veh, true)

        local rnd = math.random(0,255)

        setVehicleColor(veh, rnd, rnd, rnd, rnd, rnd)

        warpPedIntoVehicle(i, veh)
        index = index + 1
    end
end

function createCrossedDerbyVehicles()
    local index = 1

    for i, v in pairs(eventData.playersLeft) do
        local pos = data.standardDerby.pos[index]

        setElementInterior(i, 0)
        setElementDimension(i, 0)

        local veh = createVehicle(data.standardDerby.model, pos.x, pos.y, pos.z, 0, 0, pos.w)
        setElementData(veh, "vehicleData", {
            fuel = 80,
            mileage = math.random(20000, 50000),
        }, false)
        setElementData(i, "engineState", true, false)
        setElementData(veh, "blockAction", true)
        setVehicleEngineState(veh, true)

        setElementData(veh, 'derby', true)

        setVehicleColor(veh, 0, 0, 0, 0, 0, 0)

        warpPedIntoVehicle(i, veh)
        index = index + 1
    end
end

function createRandomDerbyVehicles()
    local index = 1

    for i, v in pairs(eventData.playersLeft) do
        local pos = data.randomDerby.pos[index]

        setElementInterior(i, 0)
        setElementDimension(i, 0)

        local veh = createVehicle(415, pos.x, pos.y, 41, 0, 0, pos.z)
        setElementData(veh, "vehicleData", {
            fuel = 80,
            mileage = math.random(20000, 50000),
        }, false)
        setElementData(i, "engineState", true, false)
        setElementData(veh, "blockAction", true)
        setVehicleEngineState(veh, true)

        setElementData(veh, 'derby', true)

        warpPedIntoVehicle(i, veh)
        index = index + 1
    end
end

function createDerbyVehicles()
    if eventData.events[eventData.selectedEvent].type == "monsterDerby" then
        createMonsterDerbyVehicles()

    elseif eventData.events[eventData.selectedEvent].type == "crossedDerby" then
        createCrossedDerbyVehicles()

    elseif eventData.events[eventData.selectedEvent].type == "randomDerby" then
        createRandomDerbyVehicles()
    end
end


function getPointFromDistanceRotation(x, y, dist, angle)
    local a = math.rad(90 - angle);
    local dx = math.cos(a) * dist;
    local dy = math.sin(a) * dist;
    return x+dx, y+dy;
end

function findRotation( x1, y1, x2, y2 )
    local t = -math.deg( math.atan2( x2 - x1, y2 - y1 ) )
    return t < 0 and t + 360 or t
end